<div class="settings-page">
  <header class="settings-header">
    <div class="header-left">
      <div class="header-icon">
        <span class="material-icons-round">settings</span>
      </div>
      <div>
        <h1>Configurações Enterprise</h1>
        <p>Gerencie integrações e regras de automação do HSP CRM</p>
      </div>
    </div>
    <div class="header-actions">
      <button type="button" class="icon-btn">
        <span class="material-icons-round">help_outline</span>
      </button>
      <div class="divider"></div>
      <button type="button" class="primary-action" [disabled]="saving || !authService.isAdmin()" (click)="saveSettings()">
        <span class="material-icons-round">save</span>
        {{ saving ? 'Salvando...' : 'Salvar Alterações' }}
      </button>
    </div>
  </header>

  <form (ngSubmit)="saveSettings()" class="settings-content">
    <div class="settings-grid">
      <div class="settings-col">
        <section class="settings-card">
          <div class="card-header">
            <div class="card-icon blue">
              <span class="material-icons-round">calendar_month</span>
            </div>
            <div>
              <h2>Google Agenda</h2>
              <p>Sincronize visitas e compromissos automaticamente.</p>
            </div>
          </div>
          <div class="card-body">
            <div class="status-row">
              <span class="status-pill" [class.connected]="calendarStatus?.connected">
                {{ calendarStatus?.connected ? 'Conectado' : 'Desconectado' }}
              </span>
              <div>
                <p class="status-title">
                  {{ calendarStatus?.connected ? 'Sincronizacao ativa' : 'Sincronizacao desativada' }}
                </p>
                <p class="status-subtitle" *ngIf="calendarStatus?.email">
                  Conta vinculada: {{ calendarStatus?.email }}
                </p>
                <p class="status-subtitle" *ngIf="calendarStatus?.lastSyncAt">
                  Ultima sincronizacao: {{ calendarStatus?.lastSyncAt | date:'dd/MM/yyyy HH:mm' }}
                </p>
                <p class="status-subtitle" *ngIf="!calendarStatus && !calendarLoading">
                  Status indisponivel. Clique em \"Atualizar status\".
                </p>
              </div>
            </div>

            <div class="form-stack">
              <div class="floating-field">
                <label>Calendário ID</label>
                <input
                  type="text"
                  name="calendar_id_override"
                  [(ngModel)]="calendarIdOverride"
                  placeholder="primary ou ID específico">
                <small>Use \"primary\" para a agenda principal ou deixe vazio para o padrão.</small>
              </div>
              <div class="inline-actions">
                <button type="button" class="secondary-action" (click)="saveCalendarPreference()" [disabled]="calendarIdSaving">
                  {{ calendarIdSaving ? 'Salvando...' : 'Salvar calendario' }}
                </button>
                <button type="button" class="secondary-action ghost" (click)="loadCalendarStatus()" [disabled]="calendarLoading">
                  {{ calendarLoading ? 'Atualizando...' : 'Atualizar status' }}
                </button>
                <button *ngIf="!calendarStatus?.connected" type="button" class="primary-action small" (click)="connectGoogleCalendar()"
                        [disabled]="calendarConnecting">
                  {{ calendarConnecting ? 'Conectando...' : 'Conectar Google' }}
                </button>
                <button *ngIf="calendarStatus?.connected" type="button" class="primary-action small" (click)="reconnectGoogleCalendar()"
                        [disabled]="calendarConnecting">
                  {{ calendarConnecting ? 'Conectando...' : 'Trocar conta' }}
                </button>
                <button type="button" class="danger-action" (click)="disconnectGoogleCalendar()"
                        [disabled]="calendarDisconnecting || !calendarStatus?.connected">
                  {{ calendarDisconnecting ? 'Desconectando...' : 'Desconectar' }}
                </button>
              </div>
            </div>
          </div>
        </section>

        <section class="settings-card">
          <div class="card-header">
            <div class="card-icon amber">
              <span class="material-icons-round">notifications_active</span>
            </div>
            <div>
              <h2>Sistema de Lembretes</h2>
              <p>Configure alertas automáticos para clientes estagnados.</p>
            </div>
          </div>
          <div class="card-body">
            <div class="field-row">
              <label>Dias sem alteração para envio de lembrete</label>
              <div class="stepper">
                <button type="button" (click)="decrementDays()">-</button>
                <input
                  type="number"
                  [(ngModel)]="formData.days_without_change"
                  name="days_without_change"
                  min="1"
                  max="90">
                <button type="button" (click)="incrementDays()">+</button>
              </div>
              <span class="helper">dias úteis</span>
            </div>

            <div class="stack">
              <label>Status Monitorados</label>
              <div class="pill-row">
                <span class="pill primary">Lead</span>
                <span class="pill success">Interessado</span>
                <span class="pill purple">Fechamento</span>
                <span class="pill disabled">Cliente (Inativo)</span>
              </div>
            </div>

            <div class="stack">
              <label>Canais de Notificação</label>
              <div class="toggle-grid">
                <label class="toggle-card">
                  <div class="toggle-head">
                    <span class="material-icons-round">mail</span>
                    <input type="checkbox" [(ngModel)]="formData.email_enabled" name="email_enabled">
                  </div>
                  <h4>Email</h4>
                  <p>Envio de alertas detalhados via SMTP.</p>
                </label>
                <label class="toggle-card">
                  <div class="toggle-head">
                    <span class="material-icons-round">textsms</span>
                    <input type="checkbox" [(ngModel)]="formData.sms_enabled" name="sms_enabled">
                  </div>
                  <h4>SMS</h4>
                  <p>Notificações curtas e diretas.</p>
                </label>
                <label class="toggle-card">
                  <div class="toggle-head">
                    <span class="material-icons-round">chat</span>
                    <input type="checkbox" [(ngModel)]="formData.whatsapp_enabled" name="whatsapp_enabled">
                  </div>
                  <h4>WhatsApp</h4>
                  <p>Alertas via API oficial comercial.</p>
                </label>
              </div>
            </div>
          </div>
        </section>
      </div>

      <div class="settings-col">
        <section class="settings-card">
          <div class="card-header">
            <div class="card-icon indigo">
              <span class="material-icons-round">contact_page</span>
            </div>
            <div>
              <h2>Dados de Contato</h2>
              <p class="mini">Informações globais</p>
            </div>
          </div>
          <div class="card-body">
            <div class="input-row">
              <span class="material-icons-round">alternate_email</span>
              <input
                type="email"
                [(ngModel)]="formData.contact_email"
                name="contact_email"
                placeholder="contato@imobiliaria.com">
            </div>
            <div class="input-row">
              <span class="material-icons-round">call</span>
              <input
                type="text"
                [(ngModel)]="formData.contact_phone"
                name="contact_phone"
                placeholder="(00) 0000-0000">
            </div>
            <div class="input-row">
              <span class="material-icons-round">chat_bubble_outline</span>
              <input
                type="text"
                [(ngModel)]="formData.contact_whatsapp"
                name="contact_whatsapp"
                placeholder="(00) 00000-0000">
            </div>
          </div>
        </section>

        <section class="info-card">
          <div class="info-header">
            <span class="material-icons-round">info</span>
            <h3>Como funciona</h3>
          </div>
          <p>
            O sistema monitora automaticamente clientes sem alteração de status. Ao atingir o limite, o corretor recebe alertas nos canais ativos.
          </p>
          <div class="info-note">
            <strong>Nota:</strong> É necessário um servidor de processamento ativo para alertas agendados funcionarem corretamente.
          </div>
        </section>

        <button type="button" class="log-button">
          <span class="material-icons-round">history</span>
          Ver Log de Alterações
        </button>
      </div>
    </div>

    <div class="alert-warning" *ngIf="!authService.isAdmin()">
      <span class="warning-icon" aria-label="Aviso">⚠️</span>
      <strong>Acesso Restrito:</strong> Apenas administradores podem alterar as configurações do sistema.
    </div>
  </form>
</div>
