<div class="page-container">
  <div class="page-header">
    <h1>Imóveis</h1>
    <button (click)="openModal()" class="btn-primary">
      + Novo Imóvel
    </button>
  </div>

  <!-- Filters Section -->
  <div class="filters-card">
    <div class="filter-row">
      <div class="filter-group">
        <label>Buscar</label>
        <input 
          type="text" 
          [(ngModel)]="searchTerm" 
          placeholder="Título, endereço, bairro..." 
          class="filter-input">
      </div>
      <div class="filter-group">
        <label>Tipo</label>
        <select [(ngModel)]="filterType" class="filter-input">
          <option value="">Todos</option>
          <option value="apartamento">Apartamento</option>
          <option value="casa">Casa</option>
          <option value="terreno">Terreno</option>
          <option value="comercial">Comercial</option>
        </select>
      </div>
      <div class="filter-group">
        <label>Cidade</label>
        <input 
          type="text" 
          [(ngModel)]="filterCity" 
          placeholder="Filtrar por cidade" 
          class="filter-input">
      </div>
      <div class="filter-group">
        <label>Status</label>
        <select [(ngModel)]="filterSold" class="filter-input">
          <option value="">Todos</option>
          <option value="false">Disponível</option>
          <option value="true">Vendido</option>
        </select>
      </div>
      <div class="filter-actions">
        <button (click)="applyFilters()" class="btn-primary">Buscar</button>
        <button (click)="clearFilters()" class="btn-secondary">Limpar</button>
      </div>
    </div>
  </div>

  <!-- Modal Form -->
  <div class="modal-overlay" *ngIf="showForm" (click)="closeModal()">
    <div class="modal-content modal-large property-modal" (click)="$event.stopPropagation()">
      <form class="property-form" (ngSubmit)="saveProperty()">
        <div class="property-modal-header">
          <div class="header-left">
            <button type="button" class="icon-btn" (click)="closeModal()">
              <i class="bi bi-arrow-left"></i>
            </button>
            <div class="title-stack">
              <h2>{{ editingProperty ? 'Editar Imóvel' : 'Novo Imóvel' }} <span class="title-sep">•</span> Alta Performance</h2>
              <p class="subtitle">
                {{ editingProperty ? 'Atualize as informações do imóvel' : 'Complete os dados para publicar o anúncio' }}
              </p>
            </div>
          </div>
          <div class="header-actions">
            <button type="button" class="btn-secondary ghost" (click)="closeModal()">Cancelar</button>
            <button type="submit" class="btn-primary">
              <i class="bi bi-save"></i> Salvar Imóvel
            </button>
          </div>
        </div>

        <div class="property-modal-body">
          <div class="property-modal-grid">
            <div class="property-column">
              <section class="property-card-section">
                <h3><i class="bi bi-cash-coin"></i> Informações Financeiras e Medidas</h3>
                <div class="field-grid">
                  <div class="field-full">
                    <label>Valor de Venda (R$)*</label>
                    <div class="input-prefix">
                      <span>R$</span>
                      <input type="text"
                             [(ngModel)]="priceDisplay"
                             name="priceDisplay"
                             required
                             class="property-input"
                             placeholder="0,00"
                             inputmode="decimal"
                             (input)="onPriceInput($event)">
                    </div>
                  </div>
                  <div>
                    <label>Área Privativa (m²)</label>
                    <input type="number" [(ngModel)]="formData.areaPrivativa" name="areaPrivativa" class="property-input">
                  </div>
                  <div>
                    <label>Área Total (m²)</label>
                    <input type="number" [(ngModel)]="formData.areaTerreno" name="areaTerreno" class="property-input">
                  </div>
                  <div class="field-full">
                    <label>Área Construída (m²)</label>
                    <input type="number" [(ngModel)]="formData.areaConstrutiva" name="areaConstrutiva" class="property-input">
                  </div>
                </div>
              </section>

              <section class="property-card-section">
                <h3><i class="bi bi-house-door"></i> Cômodos e Estrutura</h3>
                <div class="field-grid compact">
                  <div class="stepper-field">
                    <label>Dormitórios</label>
                    <div class="stepper">
                      <button type="button" (click)="adjustNumber('bedrooms', -1); $event.preventDefault()"><span class="stepper-icon">-</span></button>
                      <input type="number" [(ngModel)]="formData.bedrooms" name="bedrooms" class="stepper-input" min="0" inputmode="numeric">
                      <button type="button" (click)="adjustNumber('bedrooms', 1); $event.preventDefault()"><span class="stepper-icon">+</span></button>
                    </div>
                  </div>
                  <div class="stepper-field">
                    <label>Suítes</label>
                    <div class="stepper">
                      <button type="button" (click)="adjustNumber('suites', -1); $event.preventDefault()"><span class="stepper-icon">-</span></button>
                      <input type="number" [(ngModel)]="formData.suites" name="suites" class="stepper-input" min="0" inputmode="numeric">
                      <button type="button" (click)="adjustNumber('suites', 1); $event.preventDefault()"><span class="stepper-icon">+</span></button>
                    </div>
                  </div>
                  <div class="stepper-field">
                    <label>Banheiros</label>
                    <div class="stepper">
                      <button type="button" (click)="adjustNumber('bathrooms', -1); $event.preventDefault()"><span class="stepper-icon">-</span></button>
                      <input type="number" [(ngModel)]="formData.bathrooms" name="bathrooms" class="stepper-input" min="0" inputmode="numeric">
                      <button type="button" (click)="adjustNumber('bathrooms', 1); $event.preventDefault()"><span class="stepper-icon">+</span></button>
                    </div>
                  </div>
                  <div class="stepper-field">
                    <label>Vagas Garagem</label>
                    <div class="stepper">
                      <button type="button" (click)="adjustNumber('parking', -1); $event.preventDefault()"><span class="stepper-icon">-</span></button>
                      <input type="number" [(ngModel)]="formData.parking" name="parking" class="stepper-input" min="0" inputmode="numeric">
                      <button type="button" (click)="adjustNumber('parking', 1); $event.preventDefault()"><span class="stepper-icon">+</span></button>
                    </div>
                  </div>
                  <div class="stepper-field">
                    <label>Cozinhas</label>
                    <div class="stepper">
                      <button type="button" (click)="adjustNumber('kitchens', -1); $event.preventDefault()"><span class="stepper-icon">-</span></button>
                      <input type="number" [(ngModel)]="formData.kitchens" name="kitchens" class="stepper-input" min="0" inputmode="numeric">
                      <button type="button" (click)="adjustNumber('kitchens', 1); $event.preventDefault()"><span class="stepper-icon">+</span></button>
                    </div>
                  </div>
                </div>
              </section>

              <section class="property-card-section">
                <h3><i class="bi bi-stars"></i> Comodidades do Imóvel</h3>
                <div class="amenities-grid">
                  <label class="amenity-chip">
                    <input type="checkbox" [(ngModel)]="formData.diningRoom" name="diningRoom">
                    <i class="bi bi-cup-hot"></i>
                    Sala de Jantar
                  </label>
                  <label class="amenity-chip">
                    <input type="checkbox" [(ngModel)]="formData.livingRoom" name="livingRoom">
                    <i class="bi bi-tv"></i>
                    Sala de Estar
                  </label>
                  <label class="amenity-chip">
                    <input type="checkbox" [(ngModel)]="formData.serviceArea" name="serviceArea">
                    <i class="bi bi-droplet-half"></i>
                    Área de Serviço
                  </label>
                  <label class="amenity-chip">
                    <input type="checkbox" [(ngModel)]="formData.closet" name="closet">
                    <i class="bi bi-door-closed"></i>
                    Closet
                  </label>
                  <button type="button" class="amenity-add" (click)="addCustomOption()">
                    <i class="bi bi-plus-circle"></i>
                    Adicionar
                  </button>
                </div>
                <div class="custom-options" *ngIf="formData.customOptions?.length">
                  <div class="custom-option" *ngFor="let option of formData.customOptions; let i = index">
                    <input
                      type="text"
                      class="property-input"
                      [(ngModel)]="option.label"
                      name="customOptionLabel{{ i }}"
                      placeholder="Digite a comodidade">
                    <label class="custom-option-toggle">
                      <input
                        type="checkbox"
                        [(ngModel)]="option.value"
                        name="customOptionValue{{ i }}">
                      Disponível
                    </label>
                    <button type="button" class="btn-remove-inline" (click)="removeCustomOption(i)">Remover</button>
                  </div>
                </div>
              </section>
            </div>

            <div class="property-column">
              <section class="property-card-section">
                <h3><i class="bi bi-megaphone"></i> Sobre o Anúncio</h3>
                <div class="field-grid">
                  <div class="field-full">
                    <label>Título do Anúncio *</label>
                    <input type="text" [(ngModel)]="formData.title" name="title" required class="property-input" placeholder="Ex: Apartamento de Luxo nos Jardins">
                  </div>
                  <div class="field-full">
                    <label>Descrição Completa *</label>
                    <textarea [(ngModel)]="formData.description" name="description" rows="5" required class="property-input" placeholder="Descreva os diferenciais do imovel..."></textarea>
                  </div>
                  <div>
                    <label>Tipo</label>
                    <select [(ngModel)]="formData.type" name="type" required class="property-input">
                      <option value="apartamento">Apartamento</option>
                      <option value="casa">Casa</option>
                      <option value="terreno">Terreno</option>
                      <option value="comercial">Comercial</option>
                    </select>
                  </div>
                  <div>
                    <label>Status</label>
                    <select [(ngModel)]="formData.status" name="status" class="property-input">
                      <option value="pronto">Pronto para morar</option>
                      <option value="planta">Na planta</option>
                      <option value="obras">Em obras</option>
                    </select>
                  </div>
                  <div>
                    <label>Proprietário</label>
                    <select [(ngModel)]="formData.owner_id" name="owner_id" class="property-input">
                      <option value="">Nenhum</option>
                      <option *ngFor="let owner of owners" [value]="owner.id">{{ owner.name }}</option>
                    </select>
                  </div>
                  <div>
                    <label>Contato *</label>
                    <input type="text"
                           [(ngModel)]="formData.contact"
                           name="contact"
                           required
                           class="property-input"
                           inputmode="tel"
                           (input)="onContactInput($event)">
                  </div>
                  <div>
                    <label>Andar</label>
                    <input type="number" [(ngModel)]="formData.floor" name="floor" class="property-input">
                  </div>
                  <div class="inline-toggle">
                    <label>
                      <input type="checkbox" [(ngModel)]="formData.furnished" name="furnished">
                      Mobiliado
                    </label>
                  </div>
                </div>
              </section>

              <section class="property-card-section">
                <h3><i class="bi bi-geo-alt"></i> Endereço</h3>
                <div class="field-grid address-grid">
                  <div>
                    <label>CEP</label>
                    <input type="text" [(ngModel)]="formData.zip_code" name="zip_code" placeholder="00000-000" class="property-input"  (input)="onCepInput($event)" (blur)="fetchAddressFromCep()">
                  </div>
                  <div class="field-full">
                    <label>Rua / Logradouro</label>
                    <input type="text" [(ngModel)]="formData.street" name="street" class="property-input">
                  </div>
                  <div>
                    <label>Bairro</label>
                    <input type="text" [(ngModel)]="formData.neighborhood" name="neighborhood" class="property-input">
                  </div>
                  <div>
                    <label>Cidade</label>
                    <input type="text" [(ngModel)]="formData.city" name="city" class="property-input">
                  </div>
                  <div>
                    <label>UF</label>
                    <input type="text" [(ngModel)]="formData.state" name="state" maxlength="2" placeholder="UF" class="property-input" (input)="onUfInput($event)">
                  </div>
                </div>
              </section>

              <section class="property-card-section">
                <h3><i class="bi bi-image"></i> Imagens do Imóvel</h3>
                <label class="document-dropzone">
                  <input 
                    type="file" 
                    (change)="onImageSelect($event)" 
                    accept="image/*"
                    multiple
                    #documentInput>
                  <span class="drop-icon"><i class="bi bi-cloud-arrow-up"></i></span>
                  <span class="drop-title">Clique para enviar ou arraste imagens</span>
                  <span class="drop-hint">JPG, PNG, WEBP (Máximo de 12 imagens)</span>
                </label>
                <div class="document-list" *ngIf="getImageCount() > 0">
                  <div *ngFor="let doc of getImageList(); let i = index" class="document-item">
                    <span class="document-icon">{{ getFileIcon(doc.name) }}</span>
                    <span class="document-name">{{ doc.name }}</span>
                    <button type="button" (click)="removeImage(i)" class="btn-remove">×</button>
                  </div>
                </div>
                <div class="toggle-row">
                  <label class="inline-toggle">
                    <input type="checkbox" [(ngModel)]="formData.featured" name="featured">
                    Destacado
                  </label>
                  <label class="inline-toggle">
                    <input type="checkbox" [(ngModel)]="formData.sold" name="sold">
                    Vendido
                  </label>
                </div>
              </section>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <!-- Table -->
  <div class="table-card">
    <app-loading-spinner *ngIf="isLoading" message="Carregando imóveis..."></app-loading-spinner>
    <table class="data-table" *ngIf="!isLoading">
      <thead>
        <tr>
          <th>Título</th>
          <th>Tipo</th>
          <th>Endereço</th>
          <th>Cidade</th>
          <th>Proprietário</th>
          <th>Valor</th>
          <th>Status</th>
          <th>Ações</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let property of filteredProperties">
          <td>
            <div class="property-title">
              {{ property.title }}
              <span *ngIf="property.featured" class="featured-badge">⭐ Destaque</span>
            </div>
          </td>
          <td>{{ property.type || '-' }}</td>
          <td>{{ property.street || '-' }}, {{ property.neighborhood || '-' }}</td>
          <td>{{ property.city || '-' }}</td>
          <td>{{ getOwnerName(property.owner_id) }}</td>
          <td>{{ property.price | currency:'BRL' }}</td>
          <td>
            <span class="badge" [ngClass]="property.sold ? 'badge-sold' : 'badge-available'">
              {{ property.sold ? 'Vendido' : 'Disponível' }}
            </span>
          </td>
          <td>
            <button (click)="openModal(property)" class="btn-sm">Editar</button>
            <button 
              *ngIf="authService.isAdmin()" 
              (click)="deleteProperty(property.id)" 
              class="btn-sm btn-danger">
              Excluir
            </button>
          </td>
        </tr>
        <tr *ngIf="filteredProperties.length === 0">
          <td colspan="8" class="text-center">Nenhum imóvel encontrado</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
