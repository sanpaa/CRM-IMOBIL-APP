<div class="builder-container" *ngIf="!loading">
  <!-- Header -->
  <div class="builder-header">
    <div class="header-left">
      <h1>ğŸ¨ Construtor de Sites</h1>
      <div class="layout-selector" *ngIf="currentLayout">
        <select [(ngModel)]="currentLayout" (change)="selectLayout(currentLayout!)">
          <option *ngFor="let layout of layouts" [ngValue]="layout">
            {{ layout.name }} 
            <span *ngIf="layout.is_default">(PadrÃ£o)</span>
          </option>
        </select>
      </div>
    </div>
    
    <div class="header-actions">
      <button class="btn-secondary" (click)="showLayoutForm = true">
        â• Novo Layout
      </button>
      <button class="btn-secondary" (click)="toggleLivePreview()">
        {{ livePreviewEnabled ? 'ğŸ”² Ocultar Preview' : 'ğŸ‘ï¸ Mostrar Preview' }}
      </button>
      <button class="btn-secondary" (click)="togglePreview()">
        {{ previewMode ? 'âœï¸ Editar' : 'ğŸ–¥ï¸ Preview Completo' }}
      </button>
      <button class="btn-primary" (click)="saveLayout()" [disabled]="saving || !currentLayout">
        {{ saving ? 'Salvando...' : 'ğŸ’¾ Salvar' }}
      </button>
      <button class="btn-success" (click)="publishLayout()" [disabled]="!currentLayout">
        ğŸš€ Publicar
      </button>
    </div>
  </div>

  <!-- New Layout Form Modal -->
  <div class="modal-overlay" *ngIf="showLayoutForm" (click)="showLayoutForm = false">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <h2>Criar Novo Layout</h2>
      <form (ngSubmit)="createNewLayout()">
        <div class="form-group">
          <label>Nome do Layout *</label>
          <input type="text" [(ngModel)]="newLayoutData.name" name="name" required>
        </div>
        
        <div class="form-group">
          <label>Tipo de PÃ¡gina *</label>
          <select [(ngModel)]="newLayoutData.page_type" name="page_type" required>
            <option *ngFor="let type of pageTypes" [value]="type.value">
              {{ type.label }}
            </option>
          </select>
        </div>
        
        <div class="form-group" *ngIf="newLayoutData.page_type === 'custom'">
          <label>Slug (URL)</label>
          <input type="text" [(ngModel)]="newLayoutData.slug" name="slug" 
                 placeholder="ex: sobre-nos">
        </div>
        
        <div class="form-actions">
          <button type="button" class="btn-secondary" (click)="showLayoutForm = false">
            Cancelar
          </button>
          <button type="submit" class="btn-primary" [disabled]="saving">
            {{ saving ? 'Criando...' : 'Criar Layout' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Main Content -->
  <div class="builder-content" *ngIf="currentLayout">
    <!-- Component Library Sidebar -->
    <div class="component-library" *ngIf="!previewMode">
      <h3>ğŸ“¦ Componentes</h3>
      
      <div class="component-categories"
           cdkDropList
           id="component-library"
           [cdkDropListData]="availableComponents"
           [cdkDropListConnectedTo]="['main-sections-list']"
           [cdkDropListSortingDisabled]="true">
        <div class="component-item" 
             *ngFor="let component of availableComponents"
             cdkDrag
             [cdkDragData]="component"
             (click)="addComponent(component.type)"
             [title]="component.description">
          <span class="component-icon">{{ component.icon }}</span>
          <span class="component-name">{{ component.label }}</span>
        </div>
      </div>
    </div>

    <!-- Canvas Area -->
    <div class="canvas-area" [class.preview-mode]="previewMode" [class.with-preview]="livePreviewEnabled && !previewMode">
      <div class="canvas-header">
        <h3>{{ currentLayout.name }}</h3>
        <span class="page-type-badge">{{ currentLayout.page_type }}</span>
      </div>

      <!-- Empty State -->
      <div class="empty-state" *ngIf="sections.length === 0 && !previewMode">
        <div class="empty-icon">ğŸ“±</div>
        <h3>PÃ¡gina Vazia</h3>
        <p>Adicione componentes da biblioteca para comeÃ§ar a construir seu site</p>
      </div>

      <!-- Sections List with Drag & Drop -->
      <div class="sections-container" 
           cdkDropList
           id="main-sections-list"
           [cdkDropListData]="sections"
           (cdkDropListDropped)="onDrop($event)">
        
        <div class="section-wrapper"
             *ngFor="let section of sections"
             cdkDrag
             [class.selected]="selectedSection === section"
             (click)="selectSection(section)">
          
          <!-- Drag Handle -->
          <div class="drag-handle" cdkDragHandle *ngIf="!previewMode">
            <span>â‹®â‹®</span>
          </div>
          
          <!-- Section Actions -->
          <div class="section-actions" *ngIf="!previewMode">
            <button class="btn-icon" (click)="duplicateSection(section); $event.stopPropagation()" 
                    title="Duplicar">
              ğŸ“‹
            </button>
            <button class="btn-icon" (click)="removeSection(section); $event.stopPropagation()" 
                    title="Remover">
              ğŸ—‘ï¸
            </button>
          </div>
          
          <!-- Dynamic Component Rendering -->
          <ng-container *appRenderComponent="section; editMode: !previewMode"></ng-container>
          
          <!-- Drag Preview -->
          <div class="drag-preview" *cdkDragPreview>
            <div class="section-preview-compact">
              {{ getComponentIcon(section.type) }} {{ getComponentLabel(section.type) }}
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Live Preview Panel -->
    <div class="live-preview-panel" *ngIf="livePreviewEnabled && !previewMode">
      <div class="preview-header">
        <h3>ğŸ‘ï¸ Preview ao Vivo</h3>
        <div class="preview-controls">
          <div class="device-selector">
            <button 
              class="device-btn" 
              [class.active]="previewDevice === 'desktop'"
              (click)="setPreviewDevice('desktop')"
              title="Desktop">
              ğŸ–¥ï¸
            </button>
            <button 
              class="device-btn" 
              [class.active]="previewDevice === 'tablet'"
              (click)="setPreviewDevice('tablet')"
              title="Tablet">
              ğŸ“±
            </button>
            <button 
              class="device-btn" 
              [class.active]="previewDevice === 'mobile'"
              (click)="setPreviewDevice('mobile')"
              title="Mobile">
              ğŸ“±
            </button>
          </div>
          <button class="fullscreen-btn" (click)="toggleFullScreenPreview()" title="Tela Cheia">
            {{ fullScreenPreview ? 'âœ•' : 'â›¶' }}
          </button>
        </div>
      </div>
      
      <div class="preview-container">
        <div class="preview-wrapper" [class]="'device-' + previewDevice">
          <div class="preview-website">
            <!-- Render preview sections with shared components -->
            <ng-container *ngFor="let section of sections">
              <ng-container *appRenderComponent="section; editMode: false"></ng-container>
            </ng-container>

            <!-- Empty preview message -->
            <div class="preview-empty" *ngIf="sections.length === 0">
              <p>Adicione componentes para ver o preview</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Properties Panel with Auto-Generated Editor -->
    <div class="properties-panel" *ngIf="selectedSection && !previewMode">
      <app-property-editor 
        [section]="selectedSection"
        (configChange)="onConfigChange($event)"
        (styleChange)="onStyleChange($event)">
      </app-property-editor>
      
      <!-- Layout Actions -->
      <div class="property-section">
        <h4>AÃ§Ãµes do Layout</h4>
        <button class="btn-danger btn-block" (click)="deleteLayout()">
          ğŸ—‘ï¸ Excluir Layout
        </button>
      </div>
    </div>
  </div>

  <!-- No Layout State -->
  <div class="no-layout-state" *ngIf="!currentLayout && layouts.length === 0">
    <div class="empty-icon">ğŸ¨</div>
    <h2>Nenhum Layout Encontrado</h2>
    <p>Crie seu primeiro layout para comeÃ§ar a personalizar seu site</p>
    <button class="btn-primary btn-large" (click)="showLayoutForm = true">
      â• Criar Primeiro Layout
    </button>
  </div>
</div>

<div class="loading-state" *ngIf="loading">
  <div class="spinner"></div>
  <p>Carregando construtor de sites...</p>
</div>

<!-- Full Screen Preview Modal -->
<div class="fullscreen-preview-overlay" *ngIf="fullScreenPreview" (click)="toggleFullScreenPreview()">
  <div class="fullscreen-preview-content" (click)="$event.stopPropagation()">
    <div class="fullscreen-header">
      <h2>ğŸ‘ï¸ Preview Completo - {{ currentLayout?.name }}</h2>
      <div class="fullscreen-controls">
        <div class="device-selector">
          <button 
            class="device-btn" 
            [class.active]="previewDevice === 'desktop'"
            (click)="setPreviewDevice('desktop')"
            title="Desktop">
            ğŸ–¥ï¸ Desktop
          </button>
          <button 
            class="device-btn" 
            [class.active]="previewDevice === 'tablet'"
            (click)="setPreviewDevice('tablet')"
            title="Tablet">
            ğŸ“± Tablet
          </button>
          <button 
            class="device-btn" 
            [class.active]="previewDevice === 'mobile'"
            (click)="setPreviewDevice('mobile')"
            title="Mobile">
            ğŸ“± Mobile
          </button>
        </div>
        <button class="btn-close" (click)="toggleFullScreenPreview()">âœ• Fechar</button>
      </div>
    </div>
    
    <div class="fullscreen-preview-body">
      <div class="preview-wrapper-fullscreen" [class]="'device-' + previewDevice">
        <div class="preview-website">
          <!-- Render fullscreen preview sections -->
          <ng-container *ngFor="let section of sections">
            <ng-container *appRenderComponent="section; editMode: false"></ng-container>
          </ng-container>

          <!-- Empty preview message -->
          <div class="preview-empty" *ngIf="sections.length === 0">
            <p>Adicione componentes para ver o preview</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
